<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGP Visualization</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'summary/css/agp_visualization.css' %}">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Ambulatory Glucose Profile (AGP)</h1>
            
            <div class="date-selector">
                <label for="periodSelect">Period:</label>
                <select id="periodSelect" onchange="changePeriodDays()">
                    {% for period in available_periods %}
                    <option value="{{ period }}" {% if period == period_days %}selected{% endif %}>
                        {{ period }} days
                    </option>
                    {% endfor %}
                </select>
                
                {% if available_dates %}
                <label for="dateSelect" style="margin-left: 15px;">Date:</label>
                <select id="dateSelect" onchange="changeDate()">
                    {% for date in available_dates %}
                    <option value="{{ date }}" {% if date == selected_date %}selected{% endif %}>
                        {{ date|date:"M d, Y" }}
                    </option>
                    {% endfor %}
                </select>
                {% endif %}
            </div>
        </div>

        <div class="main-layout">
            <div class="left-column">
                {% if error_message %}
                <div class="alert">
                    <strong>⚠️ {{ error_message }}</strong>
                    <p style="margin-top: 10px; color: #666; font-size: 14px;">
                        To generate rolling summaries with AGP data, ensure the daily summary task is running.
                    </p>
                </div>
                {% endif %}

                {% if summary %}
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Average Glucose</div>
                        <div class="stat-value">{{ summary.glucose_avg }}<span class="stat-unit"> mg/dL</span></div>
                    </div>
                    <div class="stat-card" style="border-left-color: #28a745;">
                        <div class="stat-label">Time in Range</div>
                        <div class="stat-value">{{ summary.time_in_range }}<span class="stat-unit">%</span></div>
                    </div>
                    <div class="stat-card" style="border-left-color: #ffc107;">
                        <div class="stat-label">Time Below Range</div>
                        <div class="stat-value">{{ summary.time_below_range }}<span class="stat-unit">%</span></div>
                    </div>
                    <div class="stat-card" style="border-left-color: #dc3545;">
                        <div class="stat-label">Time Above Range</div>
                        <div class="stat-value">{{ summary.time_above_range }}<span class="stat-unit">%</span></div>
                    </div>
                </div>

                <div class="chart-container">
                    <div id="agpChart"></div>
                </div>

                {% if plotly_graph %}
                <script>
                    try {
                        var graphData = {{ plotly_graph|safe }};
                        Plotly.newPlot('agpChart', graphData.data, graphData.layout, {responsive: true});
                    } catch (error) {
                        console.error('Error rendering Plotly graph:', error);
                        document.getElementById('agpChart').innerHTML = '<div style="padding: 40px; text-align: center; color: #dc3545;"><strong>Error rendering graph:</strong><br>' + error.message + '</div>';
                    }
                </script>
                {% else %}
                <script>
                    document.getElementById('agpChart').innerHTML = '<div style="padding: 40px; text-align: center; color: #666;">No AGP graph data available for this period.</div>';
                </script>
                {% endif %}

                {% else %}
                <p style="padding: 20px; text-align: center; color: #666;">No AGP data available. Please ensure rolling summaries are calculated.</p>
                {% endif %}
            </div>

            <div class="right-column">
                <!-- Right column content goes here -->
            </div>
        </div>
    </div>

    <script>
        function changePeriodDays() {
            const periodSelect = document.getElementById('periodSelect');
            const selectedPeriod = periodSelect.value;
            window.location.href = '?period_days=' + selectedPeriod;
        }
        
        function changeDate() {
            const periodSelect = document.getElementById('periodSelect');
            const dateSelect = document.getElementById('dateSelect');
            const selectedPeriod = periodSelect.value;
            const selectedDate = dateSelect.value;
            window.location.href = '?period_days=' + selectedPeriod + '&date=' + selectedDate;
        }
    </script>
</body>
</html>
